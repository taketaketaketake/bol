---
export const prerender = false;
import Layout from '../../layout/Layout.astro';
import ResetPasswordForm from '../../components/auth/ResetPasswordForm';
---

<Layout title="Reset Password">
  <main class="min-h-screen bg-brand-bg flex flex-col justify-center py-12 sm:px-6 lg:px-8">
    <div class="sm:mx-auto sm:w-full sm:max-w-md">
      <a href="/" class="flex justify-center mb-6">
        <div class="text-2xl font-bold text-brand-primary">Bags of Laundry</div>
      </a>
      <h2 class="text-center text-3xl font-extrabold text-brand-text">
        Create new password
      </h2>
      <p class="mt-2 text-center text-sm text-brand-muted">
        Enter your new password below
      </p>
    </div>

    <div class="mt-8 mx-auto w-full" style="max-width: 400px;">
      <div class="bg-white py-8 px-8 shadow-lg border border-gray-200 rounded-lg">
        <ResetPasswordForm client:load />
      </div>
    </div>
  </main>

  <script>
    // Handle password reset tokens from hash fragment (similar to OAuth)
    if (window.location.hash && window.location.hash.includes('access_token')) {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      const access_token = params.get('access_token');
      const refresh_token = params.get('refresh_token');

      if (access_token && refresh_token) {
        // Send tokens to server to set session cookies
        fetch('/api/auth/set-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ access_token, refresh_token })
        }).then(res => {
          if (res.ok) {
            // Reload page to show form with session
            window.location.hash = '';
            window.location.reload();
          }
        }).catch(err => {
          console.error('Session error:', err);
        });
      }
    }
  </script>
</Layout>
