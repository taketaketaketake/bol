<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>ğŸ§ LiveKit Voice Room Test</title>
    <!-- Inline script ensures Astro/Vite doesn't try to bundle -->
    <script src="/livekit/livekit-client.umd.js" is:inline></script>

    <script type="module">
      async function joinRoom() {
        const statusEl = document.getElementById("status");
        const listEl = document.getElementById("participants");

        try {
          console.log("ğŸŸ¡ Step 1: Fetching LiveKit credentials...");
          statusEl.textContent = "ğŸ”„ Fetching credentials...";

          const [configResp, tokenResp] = await Promise.all([
            fetch("/api/voice/config"),
            fetch("/api/voice/token"),
          ]);

          const { url } = await configResp.json();
          const { token } = await tokenResp.json();

          console.log("âœ… Got LiveKit URL:", url);
          console.log("âœ… Got JWT token (first 60 chars):", token.slice(0, 60));
          statusEl.textContent = "ğŸ™ï¸ Connecting to LiveKit...";

          console.log("ğŸŸ¡ Step 2: Waiting for Livekit global to load...");
          const waitForLiveKit = () =>
            new Promise((resolve) => {
              const check = () => {
                if (window.Livekit) {
                  console.log("âœ… window.Livekit is ready");
                  resolve(window.Livekit);
                } else {
                  setTimeout(check, 50);
                }
              };
              check();
            });

          const { connect } = await waitForLiveKit();
          console.log("ğŸ“¡ connect() function found:", typeof connect);

          console.log("ğŸŸ¢ Step 3: Attempting to connect...");
          const room = await connect(url, token);
          console.log("âœ… Connected! Room name:", room.name);
          console.log("ğŸ‘¤ Local participant:", room.localParticipant.identity);

          statusEl.textContent = `âœ… Connected to room: ${room.name}`;

          // Render participants in list
          function renderParticipants() {
            listEl.innerHTML = "";
            const localLi = document.createElement("li");
            localLi.textContent = `ğŸ§ You (${room.localParticipant.identity})`;
            listEl.appendChild(localLi);

            for (const participant of room.participants.values()) {
              const li = document.createElement("li");
              li.textContent = `ğŸ‘¤ ${participant.identity}`;
              listEl.appendChild(li);
            }
          }

          renderParticipants();

          // Event listeners
          room.on("participantConnected", (p) => {
            console.log("ğŸ‘¥ Participant joined:", p.identity);
            renderParticipants();
          });

          room.on("participantDisconnected", (p) => {
            console.log("ğŸšª Participant left:", p.identity);
            renderParticipants();
          });

          room.on("trackSubscribed", (track, pub, participant) => {
            if (track.kind === "audio") {
              const audioEl = track.attach();
              document.body.append(audioEl);
              console.log("ğŸ”Š Subscribed to audio from:", participant.identity);
            }
          });

          room.on("disconnected", () => {
            console.warn("ğŸ”´ Room disconnected");
            statusEl.textContent = "ğŸ”´ Disconnected";
          });
        } catch (err) {
          console.error("âŒ LiveKit connection failed:", err);
          statusEl.textContent = "âŒ Connection failed: " + err.message;
        }
      }

      joinRoom();
    </script>

    <style>
      body {
        font-family: system-ui, sans-serif;
        text-align: center;
        margin: 2rem auto;
        max-width: 600px;
        background: #fafafa;
        color: #111;
      }
      h1 {
        font-size: 1.8rem;
        margin-bottom: 1rem;
      }
      #status {
        font-weight: 600;
        margin: 1rem 0;
      }
      ul {
        list-style: none;
        padding: 0;
        margin-top: 1rem;
      }
      li {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        padding: 0.5rem 1rem;
        margin-bottom: 0.5rem;
      }
    </style>
  </head>

  <body>
    <h1>ğŸ§ LiveKit Voice Room Test</h1>
    <div id="status">Initializing...</div>
    <h2>Participants</h2>
    <ul id="participants"></ul>
  </body>
</html>
