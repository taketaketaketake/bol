---
import Layout from '../layout/Layout.astro';
import { getSession } from '../utils/auth';
import { checkMembershipStatus } from '../utils/membership';
import { supabase } from '../lib/supabase';
import { MEMBERSHIP_SUBSCRIPTION_PRICE } from '../utils/pricing';

let isMember = false;
let userEmail = '';
const session = await getSession(Astro.cookies);

if (session?.user?.id) {
  // Set session on Supabase client
  const sbAccessToken = Astro.cookies.get('sb-access-token')?.value;
  const sbRefreshToken = Astro.cookies.get('sb-refresh-token')?.value;

  if (sbAccessToken && sbRefreshToken) {
    await supabase.auth.setSession({
      access_token: sbAccessToken,
      refresh_token: sbRefreshToken
    });
  }

  isMember = await checkMembershipStatus(session.user.id, supabase);
  userEmail = session.user.email || '';
}
---

<Layout title="Join Our Membership | Bags of Laundry">
  <main class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-orange-50 py-16">
    <div class="max-w-4xl mx-auto px-4">

      {isMember ? (
        <!-- Already a Member -->
        <div class="bg-white rounded-2xl shadow-lg p-8 text-center">
          <div class="mb-6">
            <span class="text-6xl">‚ú®</span>
          </div>
          <h1 class="text-3xl font-bold text-gray-900 mb-4">You're Already a Member!</h1>
          <p class="text-lg text-gray-600 mb-6">
            Your membership is active and you're enjoying all the benefits.
          </p>
          <div class="flex gap-4 justify-center">
            <a href="/order-type" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
              Place an Order
            </a>
            <a href="/dashboard" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-semibold">
              Manage Account
            </a>
          </div>
        </div>
      ) : (
        <!-- Membership Signup -->
        <div>
          <!-- Header -->
          <div class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">
              Join Our Membership
            </h1>
            <p class="text-xl text-gray-600">
              Save on every order with exclusive member benefits
            </p>
          </div>

          <!-- Pricing Card -->
          <div class="bg-white rounded-2xl shadow-xl overflow-hidden mb-8">
            <div class="bg-gradient-to-r from-orange-500 to-blue-600 text-white text-center py-4">
              <p class="text-sm font-semibold uppercase tracking-wide">Limited Time Offer</p>
            </div>

            <div class="p-8 text-center">
              <div class="mb-6">
                <div class="text-5xl font-bold text-gray-900 mb-2">
                  ${MEMBERSHIP_SUBSCRIPTION_PRICE.toFixed(2)}
                </div>
                <div class="text-gray-600 text-lg">
                  for 6 months
                </div>
                <div class="text-sm text-gray-500 mt-2">
                  That's just $8.33/month
                </div>
              </div>

              <!-- Benefits List -->
              <div class="space-y-4 mb-8 text-left max-w-md mx-auto">
                <div class="flex items-start gap-3">
                  <span class="text-2xl">üí∞</span>
                  <div>
                    <h3 class="font-semibold text-gray-900">Save $0.50/lb</h3>
                    <p class="text-sm text-gray-600">Pay just $1.75/lb instead of $2.25/lb</p>
                  </div>
                </div>

                <div class="flex items-start gap-3">
                  <span class="text-2xl">üéí</span>
                  <div>
                    <h3 class="font-semibold text-gray-900">Unlock Per-Bag Pricing</h3>
                    <p class="text-sm text-gray-600">Choose from $35, $55, or $85 fixed-price bags</p>
                  </div>
                </div>

                <div class="flex items-start gap-3">
                  <span class="text-2xl">‚≠ê</span>
                  <div>
                    <h3 class="font-semibold text-gray-900">Priority Booking</h3>
                    <p class="text-sm text-gray-600">Get first access to premium time slots</p>
                  </div>
                </div>

                <div class="flex items-start gap-3">
                  <span class="text-2xl">üöÄ</span>
                  <div>
                    <h3 class="font-semibold text-gray-900">No Commitment</h3>
                    <p class="text-sm text-gray-600">Cancel anytime, no questions asked</p>
                  </div>
                </div>
              </div>

              <!-- Savings Calculator -->
              <div class="bg-gradient-to-r from-blue-50 to-orange-50 border border-blue-200 rounded-xl p-4 mb-8">
                <p class="font-semibold text-gray-900 mb-2">üí° Break-Even Analysis</p>
                <p class="text-sm text-gray-700">
                  With just <strong>5 orders of 20 lbs each</strong> over 6 months, you'll save <strong>$50</strong> in laundry costs ‚Äî already covering your membership fee!
                </p>
              </div>
            </div>
          </div>

          <!-- Payment Form -->
          <div class="bg-white rounded-2xl shadow-lg p-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">
              Complete Your Membership Signup
            </h2>

            {!session ? (
              <!-- Not Logged In -->
              <div class="text-center py-8">
                <p class="text-gray-600 mb-6">
                  Please sign in to continue with membership signup
                </p>
                <a href="/auth/login?redirect=/membership" class="inline-block px-8 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
                  Sign In
                </a>
              </div>
            ) : (
              <!-- Logged In - Show Checkout Button -->
              <div class="text-center py-8">
                <div class="mb-6">
                  <p class="text-sm text-gray-600 mb-2">Signing up as:</p>
                  <p class="text-lg font-semibold text-gray-900">{userEmail}</p>
                </div>

                <button
                  id="checkout-button"
                  class="block w-full max-w-md mx-auto py-4 px-8 bg-gradient-to-r from-orange-500 to-blue-600 text-white rounded-xl font-bold text-lg hover:from-orange-600 hover:to-blue-700 transition-all shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  <span id="button-text">Continue to Checkout ‚Äî ${MEMBERSHIP_SUBSCRIPTION_PRICE.toFixed(2)}</span>
                  <span id="button-spinner" class="hidden">Loading...</span>
                </button>

                <div id="checkout-error" class="text-red-600 text-sm mt-4 hidden"></div>

                <!-- Security Badge -->
                <div class="mt-6">
                  <p class="text-xs text-gray-500 flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 1.944A11.954 11.954 0 012.166 5C2.056 5.649 2 6.319 2 7c0 5.225 3.34 9.67 8 11.317C14.66 16.67 18 12.225 18 7c0-.682-.057-1.35-.166-2.001A11.954 11.954 0 0110 1.944zM11 14a1 1 0 11-2 0 1 1 0 012 0zm0-7a1 1 0 10-2 0v3a1 1 0 102 0V7z" clip-rule="evenodd" />
                    </svg>
                    Secured by Stripe ‚Ä¢ 256-bit SSL encryption
                  </p>
                </div>
              </div>
            )}
          </div>

          {/* MEMBERSHIP ROI */}
          <div class="mt-12 bg-brand-bg rounded-2xl shadow-lg p-8">
            <div class="text-center mb-8 sm:mb-12">
              <h2 class="text-3xl font-bold text-brand-text mb-4">Membership Pays for Itself</h2>
              <p class="text-gray-600 text-sm sm:text-base">See how quickly you'll recover your ${MEMBERSHIP_SUBSCRIPTION_PRICE.toFixed(2)} membership fee and start saving</p>
              <div class="inline-block bg-orange-100 border border-orange-200 rounded-xl px-6 py-3 mt-4">
                <p class="text-brand-primaryDeep font-semibold text-sm">
                  üíé Plus get up to $60 in free rush services (6 months √ó $10/month)
                </p>
              </div>
            </div>

            <div class="grid md:grid-cols-2 gap-6 sm:gap-8 mb-8">
              {/* Break-even Calculator */}
              <div class="bg-white rounded-xl p-6 sm:p-8">
                <h3 class="text-xl font-bold text-brand-text mb-4">üí∞ Break-Even Point</h3>
                <div class="bg-brand-bg rounded-xl p-6 mb-4 text-center">
                  <div class="text-5xl sm:text-6xl font-black text-brand-primaryDeep mb-2">100</div>
                  <p class="text-sm text-gray-600">pounds to break even</p>
                  <p class="text-xs text-gray-500 mt-2">That's just ~17 lbs/month</p>
                </div>
                <p class="text-sm text-gray-600 text-center">
                  At $0.50 savings per pound, your membership pays for itself after just 100 lbs of laundry
                </p>
              </div>

              {/* Total Value Breakdown */}
              <div class="bg-white rounded-xl p-6 sm:p-8">
                <h3 class="text-xl font-bold text-brand-text mb-6">üíé Total Membership Value</h3>
                <div class="space-y-4">
                  <div class="bg-brand-bg rounded-lg p-4">
                    <div class="flex justify-between items-center mb-2">
                      <span class="text-sm font-semibold text-gray-700">Per-pound discount</span>
                      <span class="text-lg font-bold text-brand-primaryDeep">$0.50/lb</span>
                    </div>
                    <p class="text-xs text-gray-500">Save on every pound vs. non-members</p>
                  </div>

                  <div class="bg-brand-bg rounded-lg p-4">
                    <div class="flex justify-between items-center mb-2">
                      <span class="text-sm font-semibold text-gray-700">Free rush services</span>
                      <span class="text-lg font-bold text-brand-primaryDeep">$60</span>
                    </div>
                    <p class="text-xs text-gray-500">6 months √ó $10/month value</p>
                  </div>

                  <div class="bg-brand-bg rounded-lg p-4">
                    <div class="flex justify-between items-center mb-2">
                      <span class="text-sm font-semibold text-gray-700">Priority scheduling</span>
                      <span class="text-lg font-bold text-brand-primaryDeep">Included</span>
                    </div>
                    <p class="text-xs text-gray-500">First pick of available time slots</p>
                  </div>

                  <div class="bg-brand-bg rounded-lg p-4">
                    <div class="flex justify-between items-center mb-2">
                      <span class="text-sm font-semibold text-gray-700">Per-bag pricing access</span>
                      <span class="text-lg font-bold text-brand-primaryDeep">Included</span>
                    </div>
                    <p class="text-xs text-gray-500">Predictable, flat-rate options</p>
                  </div>

                  <div class="border-t-2 border-orange-300 pt-4 mt-4">
                    <div class="flex justify-between items-center">
                      <span class="text-base font-bold text-brand-text">Membership Cost</span>
                      <span class="text-2xl font-black text-brand-text">${MEMBERSHIP_SUBSCRIPTION_PRICE.toFixed(2)}</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Just $8.33/month for 6 months of savings</p>
                  </div>
                </div>
              </div>
            </div>

            {/* Comparison Table */}
            <div class="bg-white rounded-xl overflow-hidden">
              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead>
                    <tr class="bg-brand-bg">
                      <th class="p-4 text-left text-sm font-bold text-brand-text">Usage Level</th>
                      <th class="p-4 text-center text-sm font-bold text-brand-text">Lbs/Month</th>
                      <th class="p-4 text-right text-sm font-bold text-brand-text">Non-Member</th>
                      <th class="p-4 text-right text-sm font-bold text-brand-text">Member**</th>
                      <th class="p-4 text-right text-sm font-bold text-brand-primaryDeep">Total Savings</th>
                    </tr>
                  </thead>
                  <tbody class="text-sm">
                    <tr class="border-t border-gray-200">
                      <td class="p-4 text-gray-600">Light User</td>
                      <td class="p-4 text-center text-gray-600">20 lbs</td>
                      <td class="p-4 text-right text-gray-600">$270.00</td>
                      <td class="p-4 text-right text-gray-600">$259.99*</td>
                      <td class="p-4 text-right font-bold text-green-600">$70.01</td>
                    </tr>
                    <tr class="border-t border-gray-200 bg-orange-50">
                      <td class="p-4 font-semibold text-brand-text">Regular User</td>
                      <td class="p-4 text-center font-semibold text-brand-text">40 lbs</td>
                      <td class="p-4 text-right text-gray-600">$540.00</td>
                      <td class="p-4 text-right text-gray-600">$469.99*</td>
                      <td class="p-4 text-right font-bold text-green-600">$130.01</td>
                    </tr>
                    <tr class="border-t border-gray-200">
                      <td class="p-4 font-semibold text-brand-text">Heavy User</td>
                      <td class="p-4 text-center font-semibold text-brand-text">60 lbs</td>
                      <td class="p-4 text-right text-gray-600">$810.00</td>
                      <td class="p-4 text-right text-gray-600">$679.99*</td>
                      <td class="p-4 text-right font-bold text-green-600">$190.01</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <p class="text-xs text-gray-500 p-4 bg-gray-50 border-t border-gray-200">
                * Includes ${MEMBERSHIP_SUBSCRIPTION_PRICE.toFixed(2)} membership fee. All calculations based on 6-month period.<br>
                ** Savings include per-pound discount + $60 value from 6 free rush services ($10/month √ó 6 months)
              </p>
            </div>

            <div class="text-center mt-8">
              <button
                id="checkout-button-roi"
                class="inline-block py-4 px-8 bg-gradient-to-r from-orange-500 to-blue-600 text-white rounded-xl font-bold text-lg hover:from-orange-600 hover:to-blue-700 transition-all shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
              >
                Join Now & Start Saving
              </button>
            </div>
          </div>

          <!-- FAQ Section -->
          <div class="mt-12 bg-white rounded-2xl shadow-lg p-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">
              Frequently Asked Questions
            </h2>

            <div class="space-y-6 max-w-2xl mx-auto">
              <div>
                <h3 class="font-semibold text-gray-900 mb-2">When does my membership start?</h3>
                <p class="text-sm text-gray-600">Your membership starts immediately after payment and lasts for 6 months.</p>
              </div>

              <div>
                <h3 class="font-semibold text-gray-900 mb-2">Can I cancel anytime?</h3>
                <p class="text-sm text-gray-600">Yes! Cancel anytime from your account settings. No questions asked.</p>
              </div>

              <div>
                <h3 class="font-semibold text-gray-900 mb-2">How much can I save?</h3>
                <p class="text-sm text-gray-600">On a typical 20 lb order, you'll save $10 per order. Most members save $50-100+ over 6 months.</p>
              </div>

              <div>
                <h3 class="font-semibold text-gray-900 mb-2">What happens after 6 months?</h3>
                <p class="text-sm text-gray-600">Your membership will renew automatically for another 6 months unless you cancel before the renewal date.</p>
              </div>
            </div>
          </div>
        </div>
      )}

    </div>
  </main>

  <script define:vars={{ userEmail }}>
    // Only run if user is logged in
    if (userEmail) {
      const checkoutButton = document.getElementById('checkout-button');
      const checkoutButtonRoi = document.getElementById('checkout-button-roi');
      const buttonText = document.getElementById('button-text');
      const buttonSpinner = document.getElementById('button-spinner');
      const errorDiv = document.getElementById('checkout-error');

      async function handleCheckout(button) {
        // Disable button
        button.disabled = true;
        if (buttonText && buttonSpinner) {
          buttonText.classList.add('hidden');
          buttonSpinner.classList.remove('hidden');
        }
        if (errorDiv) {
          errorDiv.classList.add('hidden');
        }

        try {
          // Create Checkout Session
          const response = await fetch('/api/create-membership-payment-intent', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: userEmail })
          });

          let data;
          try {
            data = await response.json();
          } catch (e) {
            throw new Error('Server error. Please try again later.');
          }

          if (!response.ok) {
            throw new Error(data.error || 'Failed to create checkout session');
          }

          if (!data.url) {
            throw new Error('Invalid response from server');
          }

          // Redirect to Stripe Checkout
          window.location.href = data.url;

        } catch (error) {
          console.error('Checkout error:', error);
          // Show error
          if (errorDiv) {
            errorDiv.textContent = error.message || 'Something went wrong. Please try again.';
            errorDiv.classList.remove('hidden');
          }

          // Re-enable button
          button.disabled = false;
          if (buttonText && buttonSpinner) {
            buttonText.classList.remove('hidden');
            buttonSpinner.classList.add('hidden');
          }
        }
      }

      if (checkoutButton) {
        checkoutButton.addEventListener('click', () => handleCheckout(checkoutButton));
      }
      
      if (checkoutButtonRoi) {
        checkoutButtonRoi.addEventListener('click', () => handleCheckout(checkoutButtonRoi));
      }
    }
  </script>
</Layout>
