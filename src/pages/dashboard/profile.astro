---
export const prerender = false;

import Layout from '../../layout/Layout.astro';
import { supabase } from '../../lib/supabase';

const { cookies } = Astro;
const accessToken = cookies.get('sb-access-token');
const refreshToken = cookies.get('sb-refresh-token');

if (!accessToken || !refreshToken) {
  return Astro.redirect('/auth/login');
}

const { data: { session } } = await supabase.auth.setSession({
  access_token: accessToken.value,
  refresh_token: refreshToken.value
});

if (!session) {
  return Astro.redirect('/auth/login');
}

const user = session.user;
const userMetadata = user.user_metadata || {};
---

<Layout title="Profile Settings">
  <div class="min-h-screen bg-brand-bg">
    <main class="max-w-3xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
      <!-- Header -->
      <div class="mb-6">
        <a href="/dashboard" class="text-sm text-brand-primary hover:underline mb-2 inline-block">&larr; Back to Dashboard</a>
        <h1 class="text-2xl sm:text-3xl font-bold text-brand-text">Profile Settings</h1>
      </div>

      <!-- Account Info -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
        <div class="p-4 border-b border-gray-200">
          <h2 class="font-semibold text-brand-text">Account Information</h2>
        </div>
        <div class="p-4">
          <form id="profile-form" class="space-y-4">
            <div>
              <label for="fullName" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
              <input
                type="text"
                id="fullName"
                name="fullName"
                value={userMetadata.full_name || ''}
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
            <div>
              <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
              <input
                type="email"
                id="email"
                name="email"
                value={user.email}
                disabled
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50 text-gray-500 cursor-not-allowed"
              />
              <p class="text-xs text-gray-500 mt-1">Email cannot be changed</p>
            </div>
            <div>
              <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
              <input
                type="tel"
                id="phone"
                name="phone"
                value={userMetadata.phone || ''}
                placeholder="(313) 555-0123"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
            <div>
              <button
                type="submit"
                class="w-full sm:w-auto bg-brand-primary hover:bg-orange-600 text-white px-6 py-2 rounded-md shadow-sm transition font-medium"
              >
                Save Changes
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- SMS Preferences -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
        <div class="p-4 border-b border-gray-200">
          <h2 class="font-semibold text-brand-text">SMS Notifications</h2>
          <p class="text-sm text-gray-500 mt-1">Control when we send you text messages</p>
        </div>
        <div class="p-4">
          <div class="flex items-start gap-3">
            <div class="flex items-center h-5">
              <input
                type="checkbox"
                id="smsOptIn"
                name="smsOptIn"
                class="w-4 h-4 text-brand-primary focus:ring-brand-primary border-gray-300 rounded"
              />
            </div>
            <div class="flex-1">
              <label for="smsOptIn" class="block text-sm font-medium text-gray-700">
                Receive SMS notifications
              </label>
              <p class="text-xs text-gray-500 mt-1">
                Get text messages for pickup/delivery updates. Message and data rates may apply. 
                <span class="font-medium">Reply STOP to unsubscribe anytime.</span>
              </p>
              <div id="sms-phone-warning" class="text-xs text-amber-600 mt-2 hidden">
                <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                </svg>
                Add a phone number above to receive SMS notifications
              </div>
            </div>
          </div>
          <div class="mt-4">
            <button
              type="button"
              id="save-sms-preferences"
              class="bg-brand-primary hover:bg-orange-600 text-white px-4 py-2 rounded-md shadow-sm transition font-medium text-sm"
              disabled
            >
              Save SMS Preferences
            </button>
          </div>
        </div>
      </div>

      <!-- Delivery Address -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
        <div class="p-4 border-b border-gray-200">
          <h2 class="font-semibold text-brand-text">Delivery Address</h2>
        </div>
        <div class="p-4">
          <form id="address-form" class="space-y-4">
            <div>
              <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Street Address</label>
              <input
                type="text"
                id="address"
                name="address"
                value={userMetadata.address || ''}
                placeholder="123 Main St"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
              <div class="sm:col-span-2">
                <label for="city" class="block text-sm font-medium text-gray-700 mb-1">City</label>
                <input
                  type="text"
                  id="city"
                  name="city"
                  value={userMetadata.city || ''}
                  placeholder="Detroit"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                />
              </div>
              <div>
                <label for="zipCode" class="block text-sm font-medium text-gray-700 mb-1">ZIP Code</label>
                <input
                  type="text"
                  id="zipCode"
                  name="zipCode"
                  value={userMetadata.zip_code || ''}
                  placeholder="48201"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                />
              </div>
            </div>
            <div>
              <label for="deliveryInstructions" class="block text-sm font-medium text-gray-700 mb-1">Delivery Instructions (Optional)</label>
              <textarea
                id="deliveryInstructions"
                name="deliveryInstructions"
                rows="3"
                value={userMetadata.delivery_instructions || ''}
                placeholder="Leave at front door, Ring doorbell, etc."
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
              ></textarea>
            </div>
            <div>
              <button
                type="submit"
                class="w-full sm:w-auto bg-brand-primary hover:bg-orange-600 text-white px-6 py-2 rounded-md shadow-sm transition font-medium"
              >
                Save Address
              </button>
            </div>
          </form>
        </div>
      </div>


      <!-- Change Password -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200">
        <div class="p-4 border-b border-gray-200">
          <h2 class="font-semibold text-brand-text">Change Password</h2>
        </div>
        <div class="p-4">
          <form id="password-form" class="space-y-4">
            <div>
              <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-1">New Password</label>
              <input
                type="password"
                id="newPassword"
                name="newPassword"
                minlength="6"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
            <div>
              <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
              <input
                type="password"
                id="confirmPassword"
                name="confirmPassword"
                minlength="6"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
            <div>
              <button
                type="submit"
                class="w-full sm:w-auto bg-brand-primary hover:bg-orange-600 text-white px-6 py-2 rounded-md shadow-sm transition font-medium"
              >
                Update Password
              </button>
            </div>
          </form>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Load SMS preferences on page load
    let currentSmsOptIn = false;
    let currentPhone = '';

    async function loadSmsPreferences() {
      try {
        const res = await fetch('/api/profile/sms-preferences');
        if (res.ok) {
          const data = await res.json();
          currentSmsOptIn = data.sms_opt_in;
          currentPhone = data.phone;
          
          const checkbox = document.getElementById('smsOptIn');
          const saveButton = document.getElementById('save-sms-preferences');
          
          if (checkbox) {
            checkbox.checked = currentSmsOptIn;
            updateSmsButtonState();
          }
        }
      } catch (err) {
        console.error('Failed to load SMS preferences:', err);
      }
    }

    function updateSmsButtonState() {
      const checkbox = document.getElementById('smsOptIn');
      const saveButton = document.getElementById('save-sms-preferences');
      const phoneInput = document.getElementById('phone');
      const phoneWarning = document.getElementById('sms-phone-warning');
      
      const hasChanged = checkbox?.checked !== currentSmsOptIn;
      const phoneValue = phoneInput?.value?.trim() || '';
      const hasPhone = phoneValue.length > 0;
      
      // Show/hide phone warning
      if (checkbox?.checked && !hasPhone) {
        phoneWarning?.classList.remove('hidden');
      } else {
        phoneWarning?.classList.add('hidden');
      }
      
      // Enable save button if changed
      if (saveButton) {
        saveButton.disabled = !hasChanged;
      }
    }

    // SMS preferences handler
    document.addEventListener('DOMContentLoaded', () => {
      loadSmsPreferences();
      
      const checkbox = document.getElementById('smsOptIn');
      const saveButton = document.getElementById('save-sms-preferences');
      const phoneInput = document.getElementById('phone');
      
      // Update button state when checkbox or phone changes
      checkbox?.addEventListener('change', updateSmsButtonState);
      phoneInput?.addEventListener('input', updateSmsButtonState);
      
      saveButton?.addEventListener('click', async () => {
        const isChecked = checkbox?.checked || false;
        
        try {
          saveButton.disabled = true;
          saveButton.textContent = 'Saving...';
          
          const res = await fetch('/api/profile/sms-preferences', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sms_opt_in: isChecked }),
          });

          if (res.ok) {
            currentSmsOptIn = isChecked;
            alert(isChecked ? 'SMS notifications enabled!' : 'SMS notifications disabled');
            updateSmsButtonState();
          } else {
            const error = await res.json();
            alert(`Failed to update SMS preferences: ${error.error || 'Unknown error'}`);
          }
        } catch (err) {
          alert('An error occurred while updating SMS preferences');
          console.error('SMS preferences error:', err);
        } finally {
          saveButton.textContent = 'Save SMS Preferences';
          updateSmsButtonState();
        }
      });
    });

    // Profile form handler
    const profileForm = document.getElementById('profile-form');
    profileForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target as HTMLFormElement);

      try {
        const res = await fetch('/api/profile/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            full_name: formData.get('fullName'),
            phone: formData.get('phone'),
          }),
        });

        if (res.ok) {
          alert('Profile updated successfully!');
          window.location.reload(); // Reload to show updated name in header
        } else {
          alert('Failed to update profile');
        }
      } catch (err) {
        alert('An error occurred');
      }
    });

    // Address form handler
    const addressForm = document.getElementById('address-form');
    addressForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target as HTMLFormElement);

      try {
        const res = await fetch('/api/profile/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            address: formData.get('address'),
            city: formData.get('city'),
            zip_code: formData.get('zipCode'),
            delivery_instructions: formData.get('deliveryInstructions'),
          }),
        });

        if (res.ok) {
          alert('Address saved successfully!');
        } else {
          alert('Failed to save address');
        }
      } catch (err) {
        alert('An error occurred');
      }
    });


    // Password form handler
    const passwordForm = document.getElementById('password-form');
    passwordForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target as HTMLFormElement);
      const newPassword = formData.get('newPassword');
      const confirmPassword = formData.get('confirmPassword');

      if (newPassword !== confirmPassword) {
        alert('Passwords do not match');
        return;
      }

      try {
        const res = await fetch('/api/auth/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: newPassword }),
        });

        if (res.ok) {
          alert('Password updated successfully!');
          (e.target as HTMLFormElement).reset();
        } else {
          alert('Failed to update password');
        }
      } catch (err) {
        alert('An error occurred');
      }
    });
  </script>
</Layout>
