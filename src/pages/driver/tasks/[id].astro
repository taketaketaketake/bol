---
export const prerender = false;
import Layout from '../../../layout/Layout.astro';
import { requireRole } from '../../../utils/require-role';
import { supabase } from '../../../lib/supabase';

// Check authentication - drivers and admins only
const { cookies } = Astro;
const { user, roles } = await requireRole(cookies, ['driver', 'admin']);

// Get order ID from URL
const { id: orderId } = Astro.params;

if (!orderId) {
  return Astro.redirect('/driver/dashboard?error=order_id_required');
}

// Get current driver info
let currentDriver = null;
if (roles.includes('driver')) {
  const { data: driverData } = await supabase
    .from('drivers')
    .select('*')
    .eq('auth_user_id', user.id)
    .single();
  currentDriver = driverData;
} else {
  // Admin accessing - get any driver for demo
  const { data: driverData } = await supabase
    .from('drivers')
    .select('*')
    .eq('active', true)
    .limit(1)
    .single();
  currentDriver = driverData;
}

// Get order details
const { data: order, error: orderError } = await supabase
  .from('orders')
  .select(`
    *,
    customers(full_name, phone, email),
    addresses(line1, line2, city, state, postal_code),
    time_windows!pickup_time_window_id(label, start_time, end_time),
    delivery_time_windows:time_windows!delivery_time_window_id(label, start_time, end_time),
    laundromats(name, address, phone)
  `)
  .eq('id', orderId)
  .single();

if (orderError || !order) {
  return Astro.redirect('/driver/dashboard?error=order_not_found');
}

// Check if this driver can access this order
if (roles.includes('driver') && order.driver_id !== currentDriver?.id) {
  return Astro.redirect('/driver/dashboard?error=access_denied');
}

// Helper functions
function formatAddress(address: any) {
  if (!address) return 'Address not available';
  return `${address.line1}${address.line2 ? ', ' + address.line2 : ''}, ${address.city}, ${address.state} ${address.postal_code}`;
}

function getGoogleMapsUrl(address: any) {
  if (!address) return '#';
  const addressString = formatAddress(address);
  return `https://maps.google.com/?q=${encodeURIComponent(addressString)}`;
}

function getTaskType(status: string) {
  if (['scheduled', 'en_route_pickup'].includes(status)) {
    return 'PICKUP';
  } else if (['ready_for_delivery', 'en_route_delivery'].includes(status)) {
    return 'DELIVERY';
  }
  return 'IN PROCESS';
}

function getStatusColor(status: string) {
  switch (status) {
    case 'scheduled':
      return 'bg-blue-100 text-blue-800';
    case 'en_route_pickup':
      return 'bg-yellow-100 text-yellow-800';
    case 'picked_up':
      return 'bg-purple-100 text-purple-800';
    case 'processing':
      return 'bg-orange-100 text-orange-800';
    case 'ready_for_delivery':
      return 'bg-green-100 text-green-800';
    case 'en_route_delivery':
      return 'bg-blue-100 text-blue-800';
    default:
      return 'bg-gray-100 text-gray-800';
  }
}

function getNextActions(status: string) {
  switch (status) {
    case 'scheduled':
      return [
        { label: 'Start Route', action: 'start_route', style: 'primary' },
        { label: 'Complete Pickup', action: 'pickup', style: 'secondary', requiresPhoto: true }
      ];
    case 'en_route_pickup':
      return [
        { label: 'Complete Pickup', action: 'pickup', style: 'primary', requiresPhoto: true }
      ];
    case 'ready_for_delivery':
      return [
        { label: 'Start Delivery', action: 'start_delivery', style: 'primary' },
        { label: 'Complete Delivery', action: 'delivery', style: 'secondary', requiresPhoto: true }
      ];
    case 'en_route_delivery':
      return [
        { label: 'Complete Delivery', action: 'delivery', style: 'primary', requiresPhoto: true }
      ];
    default:
      return [];
  }
}

const taskType = getTaskType(order.status);
const nextActions = getNextActions(order.status);
const isPickupTask = taskType === 'PICKUP';
const isDeliveryTask = taskType === 'DELIVERY';
---

<Layout title={`Task #${order.id.split('-')[0]} - Driver Dashboard`}>
  <main class="min-h-screen bg-brand-bg">
    <!-- Header -->
    <div class="bg-white border-b border-gray-200 sticky top-0 z-10">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="py-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
              <a href="/driver/dashboard" 
                 class="text-brand-muted hover:text-brand-text transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
              </a>
              <div>
                <h1 class="text-xl font-bold text-brand-text">Task #{order.id.split('-')[0]}</h1>
                <p class="text-sm text-brand-muted">{taskType} Task</p>
              </div>
            </div>
            <div class="flex items-center space-x-3">
              <span class={`px-3 py-1 rounded-full text-xs font-medium ${getStatusColor(order.status)}`}>
                {order.status.toUpperCase()}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <div class="space-y-6">
        
        <!-- Customer Details Card -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
          <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">Customer Details</h2>
          </div>
          <div class="p-6">
            <div class="grid md:grid-cols-2 gap-6">
              <div>
                <h3 class="font-medium text-gray-900 mb-2">Contact Information</h3>
                <div class="space-y-2">
                  <p class="text-lg font-semibold text-brand-text">{order.customers?.full_name}</p>
                  <a href={`tel:${order.customers?.phone}`} 
                     class="text-brand-primary hover:underline flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                    </svg>
                    {order.customers?.phone}
                  </a>
                  <p class="text-sm text-brand-muted">{order.customers?.email}</p>
                </div>
              </div>
              <div>
                <h3 class="font-medium text-gray-900 mb-2">Service Details</h3>
                <div class="space-y-1 text-sm">
                  <p><span class="font-medium">Service:</span> {order.service_type}</p>
                  <p><span class="font-medium">Date:</span> {new Date(order.pickup_date).toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })}</p>
                  <p><span class="font-medium">Window:</span> {order.time_windows?.label || 'Anytime'}</p>
                  {order.notes && (
                    <p><span class="font-medium">Notes:</span> {order.notes}</p>
                  )}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Address Card -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
          <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">
              {isPickupTask ? 'Pickup' : 'Delivery'} Address
            </h2>
          </div>
          <div class="p-6">
            <div class="flex justify-between items-start">
              <div>
                <p class="text-lg font-medium text-brand-text mb-2">
                  {formatAddress(order.addresses)}
                </p>
                {order.time_windows && (
                  <p class="text-brand-muted mb-4">
                    Time Window: {order.time_windows.label} 
                    ({order.time_windows.start_time} - {order.time_windows.end_time})
                  </p>
                )}
                <a href={getGoogleMapsUrl(order.addresses)}
                   target="_blank"
                   class="inline-flex items-center bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                  </svg>
                  Open in Google Maps
                </a>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        {nextActions.length > 0 && (
          <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Actions</h2>
            <div class="space-y-4">
              {nextActions.map(action => (
                <div>
                  {action.requiresPhoto ? (
                    <!-- Photo upload action -->
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                      <div class="photo-action" data-action={action.action} data-order-id={order.id}>
                        <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">{action.label}</h3>
                        <p class="text-gray-500 mb-4">
                          {action.action === 'pickup' 
                            ? 'Take a photo of the laundry before pickup' 
                            : 'Take a photo of the delivered items as proof of delivery'
                          }
                        </p>
                        
                        <!-- Photo Input -->
                        <input type="file" 
                               accept="image/*" 
                               capture="environment"
                               class="hidden" 
                               id={`photo-input-${action.action}`} />
                        
                        <!-- Weight Input (for pickup only) -->
                        {action.action === 'pickup' && (
                          <div class="mb-4 max-w-xs mx-auto">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                              Actual Weight (optional)
                            </label>
                            <input type="number" 
                                   step="0.1" 
                                   placeholder="0.0 lbs"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand-primary"
                                   id={`weight-input-${action.action}`} />
                          </div>
                        )}

                        <!-- Delivery Notes (for delivery only) -->
                        {action.action === 'delivery' && (
                          <div class="mb-4 max-w-md mx-auto">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                              Delivery Notes (optional)
                            </label>
                            <textarea 
                              placeholder="e.g., left at door, handed to customer"
                              rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand-primary"
                              id={`notes-input-${action.action}`}></textarea>
                          </div>
                        )}

                        <!-- Upload Button -->
                        <label for={`photo-input-${action.action}`} 
                               class="inline-flex items-center bg-brand-primary text-white px-6 py-3 rounded-lg hover:bg-brand-primary/90 transition-colors cursor-pointer">
                          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                          </svg>
                          Take Photo & {action.label}
                        </label>

                        <!-- Loading State -->
                        <div class="loading-state hidden">
                          <div class="inline-flex items-center text-brand-primary">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5" fill="none" viewBox="0 0 24 24">
                              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Processing...
                          </div>
                        </div>

                        <!-- Error State -->
                        <div class="error-state hidden">
                          <div class="text-red-600 text-sm mt-2"></div>
                        </div>
                      </div>
                    </div>
                  ) : (
                    <!-- Simple button action -->
                    <button type="button" 
                            class="simple-action w-full bg-brand-primary text-white py-4 px-6 rounded-lg hover:bg-brand-primary/90 transition-colors font-semibold text-lg"
                            data-action={action.action} 
                            data-order-id={order.id}>
                      {action.label}
                    </button>
                  )}
                </div>
              ))}
            </div>
          </div>
        )}

        <!-- Order Progress (if in process) -->
        {['picked_up', 'processing'].includes(order.status) && (
          <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Order Progress</h2>
            <div class="space-y-2">
              <div class="flex items-center text-green-600">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
                <span>Picked up from customer</span>
              </div>
              <div class={`flex items-center ${order.status === 'processing' ? 'text-orange-600' : 'text-gray-400'}`}>
                {order.status === 'processing' ? (
                  <svg class="w-5 h-5 mr-2 animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                ) : (
                  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                )}
                <span>Being processed at {order.laundromats?.name || 'laundromat'}</span>
              </div>
              <div class="flex items-center text-gray-400">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <span>Ready for delivery</span>
              </div>
            </div>
          </div>
        )}

        <!-- Big DONE Button (if task is complete) -->
        {['delivered', 'completed'].includes(order.status) && (
          <div class="bg-green-50 border border-green-200 rounded-lg p-8 text-center">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-8 h-8 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
              </svg>
            </div>
            <h2 class="text-2xl font-bold text-green-800 mb-2">DONE!</h2>
            <p class="text-green-700 mb-4">Task completed successfully</p>
            <a href="/driver/dashboard" 
               class="inline-flex items-center bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors">
              Back to Dashboard
            </a>
          </div>
        )}

      </div>
    </div>
  </main>

  <!-- JavaScript for handling actions -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Handle simple action buttons (no photo required)
      document.querySelectorAll('.simple-action').forEach(button => {
        button.addEventListener('click', async function() {
          const action = this.getAttribute('data-action');
          const orderId = this.getAttribute('data-order-id');
          
          // Show loading state
          this.disabled = true;
          this.innerHTML = '<svg class="animate-spin h-5 w-5 mr-3 inline" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Processing...';

          try {
            let endpoint = '';
            let newStatus = '';
            
            if (action === 'start_route') {
              endpoint = `/api/driver/orders/${orderId}/start-route`;
              newStatus = 'en_route_pickup';
            } else if (action === 'start_delivery') {
              endpoint = `/api/driver/orders/${orderId}/pickup-laundromat`;
              newStatus = 'en_route_delivery';
            }

            if (endpoint) {
              const response = await fetch(endpoint, { method: 'POST' });
              const data = await response.json();

              if (data.success) {
                // Refresh the page to show updated status
                window.location.reload();
              } else {
                throw new Error(data.error || 'Action failed');
              }
            }
          } catch (error) {
            console.error('Action failed:', error);
            alert('Failed to update status: ' + error.message);
            // Reset button
            this.disabled = false;
            this.innerHTML = this.getAttribute('data-original-text') || 'Try Again';
          }
        });
      });

      // Handle photo upload actions
      document.querySelectorAll('[data-action="pickup"], [data-action="delivery"]').forEach(container => {
        const action = container.getAttribute('data-action');
        const orderId = container.getAttribute('data-order-id');
        const photoInput = document.getElementById(`photo-input-${action}`);
        const weightInput = document.getElementById(`weight-input-${action}`);
        const notesInput = document.getElementById(`notes-input-${action}`);
        const loadingState = container.querySelector('.loading-state');
        const errorState = container.querySelector('.error-state');

        if (photoInput) {
          photoInput.addEventListener('change', async function() {
            const file = this.files[0];
            if (!file) return;

            // Show loading state
            loadingState.classList.remove('hidden');
            errorState.classList.add('hidden');
            this.disabled = true;

            try {
              // Create form data
              const formData = new FormData();
              formData.append('photo', file);

              // Add weight for pickup
              if (action === 'pickup' && weightInput && weightInput.value) {
                formData.append('actualWeight', weightInput.value);
              }

              // Add notes for delivery
              if (action === 'delivery' && notesInput && notesInput.value.trim()) {
                formData.append('deliveryNotes', notesInput.value.trim());
              }

              // Determine endpoint
              let endpoint = '';
              if (action === 'pickup') {
                endpoint = `/api/driver/orders/${orderId}/pickup`;
              } else if (action === 'delivery') {
                endpoint = `/api/driver/orders/${orderId}/dropoff`;
              }

              const response = await fetch(endpoint, {
                method: 'POST',
                body: formData
              });

              const data = await response.json();

              if (data.success) {
                // Show success and redirect
                alert('Photo uploaded and status updated successfully!');
                window.location.reload();
              } else {
                throw new Error(data.error || 'Upload failed');
              }
            } catch (error) {
              console.error('Photo upload failed:', error);
              
              // Show error
              errorState.classList.remove('hidden');
              errorState.querySelector('div').textContent = 'Upload failed: ' + error.message;
              
              // Reset input
              this.value = '';
              this.disabled = false;
            } finally {
              loadingState.classList.add('hidden');
            }
          });
        }
      });

      // Add keyboard support for accessibility
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.target.tagName === 'BUTTON') {
          e.target.click();
        }
      });
    });
  </script>

  <!-- Mobile optimizations -->
  <style>
    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
      
      input[type="file"] {
        font-size: 16px; /* Prevents zoom on iOS */
      }
      
      .photo-action label {
        padding: 1rem 1.5rem;
        font-size: 1rem;
      }
    }
    
    /* Loading animation */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .animate-spin {
      animation: spin 1s linear infinite;
    }
  </style>
</Layout>